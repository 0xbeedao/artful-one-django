{% extends "item_base.html" %}{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block rel_canonical %}{% endblock %}

{% block item_content %}
{% load blog_tags %}
<h2 class="ui header">{{ title }}</h2>

<form class="ui form" action="{{ request.path }}" method="GET">
    <div class="fields">
        <div class="fourteen wide field">
            <input type="search" class="search-input" name="q" value="{{ q }}" placeholder="Search..." autocomplete="off">
        </div>
        <div class="two wide field">
            <button class="ui primary button" type="submit">Search</button>
        </div>
    </div>
    {% if selected %}
        {% for pair in selected.items %}
            {% if pair.0 == 'tags' %}
                {% for tag in pair.1 %}
                    <input type="hidden" name="tag" value="{{ tag }}">
                {% endfor %}
            {% else %}
                <input type="hidden" name="{{ pair.0 }}" value="{{ pair.1 }}">
            {% endif %}
        {% endfor %}
    {% endif %}
</form>

<div class="ui segment search-selections">
    {% if selected %}
        <div class="ui labels">
            <div class="ui label">Filters:</div>
            {% if selected.type %}
                <a class="ui label" href="{% remove_qsarg "type" selected.type %}">
                    Type: {{ selected.type }}
                    <i class="delete icon"></i>
                </a>
            {% endif %}
            {% if selected.year %}
                <a class="ui label" href="{% remove_qsarg "year" selected.year %}">
                    Year: {{ selected.year }}
                    <i class="delete icon"></i>
                </a>
            {% endif %}
            {% if selected.month %}
                <a class="ui label" href="{% remove_qsarg "month" selected.month %}">
                    Month: {{ selected.month_name }}
                    <i class="delete icon"></i>
                </a>
            {% endif %}
            {% for tag in selected.tags %}
                <a class="ui label" href="{% remove_qsarg "tag" tag %}">
                    {{ tag }}
                    <i class="delete icon"></i>
                </a>
            {% endfor %}
        </div>
    {% endif %}
    {% if results %}
        <div style="margin-top: 1em;">
            Sorted by <strong>{{ sort }}</strong>{% if q %} &middot; {% endif %}
            {% if sort == "date" and q %}<a href="{% replace_qsarg "sort" "relevance" %}">relevance</a>{% endif %}
            {% if sort == "relevance" %}<a href="{% replace_qsarg "sort" "date" %}">date</a>{% endif %}
        </div>
    {% endif %}
</div>

<div id="autocomplete-tags" aria-live="polite"></div>

{% if total %}
    {% if selected or q %}
        {% include "_pagination.html" with page_total=total %}
        {% blog_mixed_list_with_dates results %}
        {% include "_pagination.html" %}
    {% endif %}
{% else %}
    {% if selected or q %}
        <div class="ui warning message">
            <div class="header">No results found</div>
            {% if suggestion and num_corrected_results %}
                <p>Suggestion: <a href="/search/?q={{ suggestion }}">{{ suggestion }}</a> ({{ num_corrected_results }} result{{ num_corrected_results|pluralize }})</p>
            {% endif %}
        </div>
    {% endif %}
{% endif %}

{% endblock %}

{% block secondary %}
<div class="ui segments metabox">
    {% if type_counts %}
        <div class="ui segment">
            <h3 class="ui header" id="facet-types">Types</h3>
            <div class="ui relaxed list">
                {% for t in type_counts %}
                    <div class="item">
                        <a href="{% add_qsarg "type" t.type %}">{{ t.type }}</a>
                        <span class="ui label">{{ t.n|intcomma }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% if year_counts %}
        <div class="ui segment">
            <h3 class="ui header" id="facet-years">Years</h3>
            <div class="ui relaxed list">
                {% for t in year_counts %}
                    <div class="item">
                        <a href="{% add_qsarg "year" t.year|date:"Y" %}">{{ t.year|date:"Y" }}</a>
                        <span class="ui label">{{ t.n|intcomma }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% if month_counts %}
        <div class="ui segment">
            <h3 class="ui header" id="facet-months">Months</h3>
            <div class="ui relaxed list">
                {% for t in month_counts %}
                    <div class="item">
                        <a href="{% add_qsarg "month" t.month|date:"n" %}">{{ t.month|date:"F" }}</a>
                        <span class="ui label">{{ t.n|intcomma }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% if tag_counts %}
        <div class="ui segment">
            <h3 class="ui header" id="facet-tags">Tags</h3>
            <div class="ui relaxed list">
                {% for t in tag_counts %}
                    <div class="item">
                        <a href="{% add_qsarg "tag" t.tag %}">{{ t.tag }}</a>
                        <span class="ui label">{{ t.n|intcomma }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</div>
<script>
function debounce(func, wait) {
  let timeout;
  return function (...args) {
    const context = this;
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(context, args), wait);
  };
}

function fetchTags(query) {
  fetch(`/tags-autocomplete/?q=${query}`)
    .then((response) => response.json())
    .then((data) => {
      const tagsContainer = document.getElementById("autocomplete-tags");
      tagsContainer.innerHTML = "";
      if (data.tags.length > 0) {
        const p = document.createElement("p");
        p.appendChild(document.createTextNode("Tags "));
        data.tags.forEach((tag) => {
          const a = document.createElement("a");
          a.href = `/tags/${tag.tag}/`;
          a.className = "item-tag";
          a.innerHTML = `${tag.tag} <span>${tag.count}</span>`;
          p.appendChild(a);
          // Add a space between tags
          p.appendChild(document.createTextNode(" "));
        });
        tagsContainer.appendChild(p);
      }
    });
}
const searchInput = document.querySelector(".search-input");
searchInput.addEventListener(
  "input",
  debounce(function () {
    const query = this.value.trim();
    if (query.length > 0) {
      fetchTags(query);
    } else {
      document.getElementById("autocomplete-tags").innerHTML = "";
    }
  }, 500),
);
if (searchInput.value) {
  fetchTags(searchInput.value);
}
</script>
{% endblock %}
